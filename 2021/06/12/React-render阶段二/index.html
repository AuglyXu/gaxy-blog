<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="王八吉吉">


    <meta name="subtitle" content="前端小匠">


    <meta name="description" content="专心学技术">


    <meta name="keywords" content="前端">


<title>React-render阶段(二) | Gaxy</title>



    <link rel="icon" href="/favicon.png">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


<meta name="generator" content="Hexo 4.2.1"></head>

<body>
    <script>
        // this function is used to check current theme before page loaded.
        (() => {
            const currentTheme = window.localStorage && window.localStorage.getItem('theme') || '';
            const isDark = currentTheme === 'dark';
            const pagebody = document.getElementsByTagName('body')[0]
            if (isDark) {
                pagebody.classList.add('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "· Dark"
            } else {
                pagebody.classList.remove('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "· Light"
            }
        })();
    </script>

    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">Gaxy</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">归档</a>
                
                    <a class="menu-item" href="/category">分类</a>
                
                    <a class="menu-item" href="/tag">标签</a>
                
                    <a class="menu-item" href="/about">关于</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">Gaxy</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">归档</a>
                
                    <a class="menu-item" href="/category">分类</a>
                
                    <a class="menu-item" href="/tag">标签</a>
                
                    <a class="menu-item" href="/about">关于</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
            <div class="main">
                <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    var tocbot_timer;
    var DEPTH_MAX = 6;    // 为 6 时展开所有
    var tocbot_default_config = {
        tocSelector: '.tocbot-list',
        contentSelector: '.post-content',
        headingSelector: 'h1, h2, h3, h4, h5',
        orderedList: false,
        scrollSmooth: true,
        onClick: extend_click,
    };

    function extend_click() {
        clearTimeout(tocbot_timer);
        tocbot_timer = setTimeout(function () {
            tocbot.refresh(obj_merge(tocbot_default_config, { hasInnerContainers: true }));
        }, 420); // 这个值是由 tocbot 源码里定义的 scrollSmoothDuration 得来的
    }

    document.ready(function () {
        tocbot.init(obj_merge(tocbot_default_config, { collapseDepth: 1 }));
    });

    function expandToc() {
        var b = document.querySelector('.tocbot-toc-expand');
        var expanded = b.getAttribute('data-expanded');
        expanded ? b.removeAttribute('data-expanded') : b.setAttribute('data-expanded', true);
        tocbot.refresh(obj_merge(tocbot_default_config, { collapseDepth: expanded ? 1 : DEPTH_MAX }));
        b.innerText = expanded ? 'Expand all' : 'Collapse all';
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

    function obj_merge(target, source) {
        for (var item in source) {
            if (source.hasOwnProperty(item)) {
                target[item] = source[item];
            }
        }
        return target;
    }
</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">React-render阶段(二)</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">王八吉吉</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">六月 12, 2021&nbsp;&nbsp;15:55:00</a>
                        </span>
                    
                    
                        <span class="post-category">
                    Category:
                            
                                <a href="/category/React/">React</a>
                            
                        </span>
                    
                </div>
            
        </header>

        <div class="post-content">
            <h1 id="React-render阶段-二"><a href="#React-render阶段-二" class="headerlink" title="React-render阶段(二)"></a>React-render阶段(二)</h1><h2 id="概览"><a href="#概览" class="headerlink" title="概览"></a>概览</h2><p><code>React-render阶段一</code>解释了当组件进入<code>reconciler</code>后的执行过程, 从<code>root</code>节点开始调度, 循环调用<code>beginWork</code>创建子节点. 其中创建子节点的过程又分为挂载阶段和更新阶段, 挂载阶段不追踪副作用, 更新阶段追踪副作用, 更新阶段又分为可复用和不可复用, 可复用的会进入<code>bailout</code>的复用逻辑, 会把<code>current</code>树中的当前节点以及其子节点复制到<code>workInProgress</code>树中, 没有进入<code>bailout</code>阶段的<code>Fiber</code>节点会进入<code>diff</code>算法(对应的<code>current</code>中的<code>Fiber</code>节点与返回的<code>JSX</code>对比, 生成新的<code>Fiber</code>节点), 并为新的<code>Fiber</code>节点打上<code>effectTag</code></p>
<p>当前<code>Fiber</code>节点没有子节点时就进入了<code>completeWork</code>, 可以理解为递归阶段的归阶段, <code>completeWork</code>的目的就是为了创建好对应的<code>dom</code>节点插入对应的父级节点的<code>dom</code>节点, 为其添加副作用标识, 再<code>commit</code>阶段将对应的节点展示到页面上并执行对应的副作用.</p>
<p>以下我以<code>cra</code>创建的项目的代码举例, js如下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [num, setNum] = useState(<span class="number">0</span>)</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div className=<span class="string">"App"</span>&gt;</span><br><span class="line">      &lt;header className=<span class="string">"App-header"</span>&gt;</span><br><span class="line">        &lt;img src=&#123;logo&#125; className=<span class="string">"App-logo"</span> alt=<span class="string">"logo"</span> /&gt;</span><br><span class="line">        &lt;p onClick=&#123;() =&gt; &#123; setNum(num + <span class="number">1</span>) &#125;&#125;&gt;</span><br><span class="line">          &#123;num&#125; &lt;code&gt;src/App.js&lt;<span class="regexp">/code&gt; and save to reload.</span></span><br><span class="line"><span class="regexp">        &lt;/</span>p&gt;</span><br><span class="line">        &lt;a</span><br><span class="line">          className=<span class="string">"App-link"</span></span><br><span class="line">          href=<span class="string">"https://reactjs.org"</span></span><br><span class="line">          target=<span class="string">"_blank"</span></span><br><span class="line">          rel=<span class="string">"noopener noreferrer"</span></span><br><span class="line">        &gt;</span><br><span class="line">          Learn React</span><br><span class="line">        &lt;<span class="regexp">/a&gt;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>header&gt;</span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>

<a id="more"></a>

<h3 id="CompleteWork执行时机与分析"><a href="#CompleteWork执行时机与分析" class="headerlink" title="CompleteWork执行时机与分析"></a>CompleteWork执行时机与分析</h3><p><code>completeWork</code>发生在当前<code>Fiber</code>节点没有子节点的情况下, 源码发生在<code>performUnitOfWork</code>函数中, 这个函数发生在上文提到过的<code>workLoopSync</code>中, 这个函数将被循环调用<br><img src="completeWork%E7%BB%88%E6%AD%A2%E6%9D%A1%E4%BB%B6.png" alt=""><br>上图打了两个断点处就是completeWork是否执行的条件, 第一个断点拿到的是<code>beginWork</code>创建好的子<code>Fiber</code>节点, 如果没有子<code>Fiber</code>节点则返回<code>null</code>, 只有当<code>next</code>为<code>null</code>的时候才会进入<code>completeWork</code>, <code>completeWork</code>的开始源于他的上层函数<code>completeUnitOfWork</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">completeUnitOfWork</span>(<span class="params">unitOfWork</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> completedWork = unitOfWork; <span class="comment">// 获取当前completeWork的Fiber节点</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> current = completedWork.alternate; <span class="comment">// 获取当前completeWork对应的current树上的节点, 没有则表示是新增的节点</span></span><br><span class="line">    <span class="keyword">var</span> returnFiber = completedWork.return; </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((completedWork.flags &amp; Incomplete) === NoFlags) &#123;</span><br><span class="line">      setCurrentFiber(completedWork);</span><br><span class="line">      <span class="keyword">var</span> next = <span class="keyword">void</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> ( (completedWork.mode &amp; ProfileMode) === NoMode) &#123;</span><br><span class="line">        next = completeWork(current, completedWork, subtreeRenderLanes);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        startProfilerTimer(completedWork);</span><br><span class="line">        next = completeWork(current, completedWork, subtreeRenderLanes); <span class="comment">// Update render duration assuming we didn't error.</span></span><br><span class="line"></span><br><span class="line">        stopProfilerTimerIfRunningAndRecordDelta(completedWork, <span class="literal">false</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      resetCurrentFiber();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (next !== <span class="literal">null</span>) &#123;</span><br><span class="line">        workInProgress = next;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">var</span> _next = unwindWork(completedWork, subtreeRenderLanes); <span class="comment">// Because this fiber did not complete, don't reset its expiration time.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (_next !== <span class="literal">null</span>) &#123;</span><br><span class="line">        _next.flags &amp;= HostEffectMask;</span><br><span class="line">        workInProgress = _next;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> ( (completedWork.mode &amp; ProfileMode) !== NoMode) &#123;</span><br><span class="line">        stopProfilerTimerIfRunningAndRecordDelta(completedWork, <span class="literal">false</span>); <span class="comment">// Include the time spent working on failed children before continuing.</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> actualDuration = completedWork.actualDuration;</span><br><span class="line">        <span class="keyword">var</span> child = completedWork.child;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (child !== <span class="literal">null</span>) &#123;</span><br><span class="line">          actualDuration += child.actualDuration;</span><br><span class="line">          child = child.sibling;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        completedWork.actualDuration = actualDuration;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (returnFiber !== <span class="literal">null</span>) &#123;</span><br><span class="line">        returnFiber.flags |= Incomplete;</span><br><span class="line">        returnFiber.subtreeFlags = NoFlags;</span><br><span class="line">        returnFiber.deletions = <span class="literal">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> siblingFiber = completedWork.sibling;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (siblingFiber !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// If there is more work to do in this returnFiber, do that next.</span></span><br><span class="line">      workInProgress = siblingFiber;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125; <span class="comment">// Otherwise, return to the parent</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    completedWork = returnFiber; <span class="comment">// Update the next thing we're working on in case something throws.</span></span><br><span class="line"></span><br><span class="line">    workInProgress = completedWork;</span><br><span class="line">  &#125; <span class="keyword">while</span> (completedWork !== <span class="literal">null</span>); <span class="comment">// We've reached the root.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (workInProgressRootExitStatus === RootIncomplete) &#123;</span><br><span class="line">    workInProgressRootExitStatus = RootCompleted;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>completeUnitOfWork</code>从源码中可以看到是一个<code>do while</code>循环, 终止条件有<code>completeWork !== null</code>或者循环内<code>return</code>前的几个终止条件, 我们可以看到有一个是<code>siblingFiber</code>不为<code>null</code>的情况. 即当前的节点存在兄弟节点时并且已经没有子节点, 当前节点会结束<code>completeWork</code>, 跳出调用栈, 执行下一次循环, 进入兄弟节点的<code>beginWork</code>.当兄弟节点为<code>null</code>的时候, 那么<code>completeWork</code>会被赋值为<code>returnFiber</code>, 这个时候注意并没有用<code>return</code>跳出调用栈, 因为父级节点的<code>beginWork</code>已经被执行, 因此会进入父级节点的<code>completeWork</code>, 由此向上, 当<code>completeWork</code>为<code>null</code>时意味着归到根节点</p>
<p>接下来分析一下<code>completeWork</code>做的具体的事情</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">completeWork</span>(<span class="params">current, workInProgress, renderLanes</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'completeWork'</span>, <span class="string">'tag:'</span>, workInProgress.tag, <span class="string">' type:'</span>, workInProgress.type);</span><br><span class="line">  <span class="keyword">var</span> newProps = workInProgress.pendingProps;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (workInProgress.tag) &#123;</span><br><span class="line">    <span class="keyword">case</span> IndeterminateComponent:</span><br><span class="line">    <span class="keyword">case</span> LazyComponent:</span><br><span class="line">    <span class="keyword">case</span> SimpleMemoComponent:</span><br><span class="line">    <span class="keyword">case</span> FunctionComponent:</span><br><span class="line">    <span class="keyword">case</span> ForwardRef:</span><br><span class="line">    <span class="keyword">case</span> Fragment:</span><br><span class="line">    <span class="keyword">case</span> Mode:</span><br><span class="line">    <span class="keyword">case</span> Profiler:</span><br><span class="line">    <span class="keyword">case</span> ContextConsumer:</span><br><span class="line">    <span class="keyword">case</span> MemoComponent:</span><br><span class="line">      bubbleProperties(workInProgress);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> ClassComponent:</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">var</span> Component = workInProgress.type;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (isContextProvider(Component)) &#123;</span><br><span class="line">          popContext(workInProgress);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        bubbleProperties(workInProgress);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> HostComponent:</span><br><span class="line">      &#123;</span><br><span class="line">        popHostContext(workInProgress);</span><br><span class="line">        <span class="keyword">var</span> rootContainerInstance = getRootHostContainer();</span><br><span class="line">        <span class="keyword">var</span> type = workInProgress.type;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (current !== <span class="literal">null</span> &amp;&amp; workInProgress.stateNode != <span class="literal">null</span>) &#123;</span><br><span class="line">          updateHostComponent$<span class="number">1</span>(current, workInProgress, type, newProps, rootContainerInstance);</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (current.ref !== workInProgress.ref) &#123;</span><br><span class="line">            markRef$<span class="number">1</span>(workInProgress);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (!newProps) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!(workInProgress.stateNode !== <span class="literal">null</span>)) &#123;</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="built_in">Error</span>( <span class="string">"We must have new props for new mounts. This error is likely caused by a bug in React. Please file an issue."</span> );</span><br><span class="line">              &#125;</span><br><span class="line">            &#125; <span class="comment">// This can happen when we abort work.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            bubbleProperties(workInProgress);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">var</span> currentHostContext = getHostContext(); <span class="comment">// <span class="doctag">TODO:</span> Move createInstance to beginWork and keep it on a context</span></span><br><span class="line">          <span class="comment">// "stack" as the parent. Then append children as we go in beginWork</span></span><br><span class="line">          <span class="comment">// or completeWork depending on whether we want to add them top-&gt;down or</span></span><br><span class="line">          <span class="comment">// bottom-&gt;up. Top-&gt;down is faster in IE11.</span></span><br><span class="line"></span><br><span class="line">          <span class="keyword">var</span> _wasHydrated = popHydrationState(workInProgress);</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (_wasHydrated) &#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> Move this and createInstance step into the beginPhase</span></span><br><span class="line">            <span class="comment">// to consolidate.</span></span><br><span class="line">            <span class="keyword">if</span> (prepareToHydrateHostInstance(workInProgress, rootContainerInstance, currentHostContext)) &#123;</span><br><span class="line">              <span class="comment">// If changes to the hydrated node need to be applied at the</span></span><br><span class="line">              <span class="comment">// commit-phase we mark this as such.</span></span><br><span class="line">              markUpdate(workInProgress);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">var</span> instance = createInstance(type, newProps, rootContainerInstance, currentHostContext, workInProgress);</span><br><span class="line">            appendAllChildren(instance, workInProgress, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">            workInProgress.stateNode = instance; <span class="comment">// Certain renderers require commit-time effects for initial mount.</span></span><br><span class="line">            <span class="comment">// (eg DOM renderer supports auto-focus for certain elements).</span></span><br><span class="line">            <span class="comment">// Make sure such renderers get scheduled for later work.</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (finalizeInitialChildren(instance, type, newProps, rootContainerInstance)) &#123;</span><br><span class="line">              markUpdate(workInProgress);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (workInProgress.ref !== <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// If there is a ref on a host node we need to schedule a callback</span></span><br><span class="line">            markRef$<span class="number">1</span>(workInProgress);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        bubbleProperties(workInProgress);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    <span class="comment">// ...以下省略的是针对其他组件的执行逻辑, 这里我们重点关注前几个</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的代码中看到<code>completeWork</code>函数就是针对不同的<code>Fiber</code>节点的<code>Tag</code>, 处理不同的逻辑, 我们根据<code>p</code>标签为例, 会进入<code>case</code>为<code>HostComponent</code>的分支</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// completeWork顺序如下(展示一部分, 归到p标签为止)</span></span><br><span class="line"><span class="number">1.</span> img</span><br><span class="line"><span class="number">2.</span> &#123;num&#125;</span><br><span class="line"><span class="number">3.</span> num后面的空格</span><br><span class="line"><span class="number">4.</span> code</span><br><span class="line"><span class="number">5.</span>  and save to reload.</span><br><span class="line"><span class="number">6.</span> p</span><br></pre></td></tr></table></figure>
<p><img src="completeWork%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F.png" alt=""></p>
<h4 id="mount阶段"><a href="#mount阶段" class="headerlink" title="mount阶段"></a>mount阶段</h4><p>根据上面的<code>completeWork</code>的分析, 我们直接看上面 <code>HostComponent</code> 的逻辑, 一行一行看<br>开始的逻辑都是一样的, 首先处理<code>context</code>, 获取根容器</p>
<ol>
<li><code>popHostContext</code>是和<code>context</code>相关的逻辑, 暂时跳过</li>
<li><code>rootContainerInstance</code>是获取根容器<code>&lt;div id=&quot;root&quot;&gt;&lt;/div&gt;</code><br>接下来的逻辑会根据挂载和更新进入不同的条件语句, 重新贴一下核心代码<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (current !== <span class="literal">null</span> &amp;&amp; workInProgress.stateNode != <span class="literal">null</span>) &#123;</span><br><span class="line">    updateHostComponent$<span class="number">1</span>(current, workInProgress, type, newProps, rootContainerInstance);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (current.ref !== workInProgress.ref) &#123;</span><br><span class="line">    markRef$<span class="number">1</span>(workInProgress);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!newProps) &#123; <span class="comment">// 如果没有新的props并且stateNode为null, 可能是React发生了内部错误, 挂载时newProps至少也是一个&#123;&#125;, 一定不会进这里</span></span><br><span class="line">        <span class="keyword">if</span> (!(workInProgress.stateNode !== <span class="literal">null</span>)) &#123;</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="built_in">Error</span>( <span class="string">"We must have new props for new mounts. This error is likely caused by a bug in React. Please file an issue."</span> );</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="comment">// This can happen when we abort work.</span></span><br><span class="line">        bubbleProperties(workInProgress);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> currentHostContext = getHostContext(); <span class="comment">// context相关</span></span><br><span class="line">    <span class="keyword">var</span> _wasHydrated = popHydrationState(workInProgress); <span class="comment">// 服务端渲染相关</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (_wasHydrated) &#123;<span class="comment">// 服务端渲染</span></span><br><span class="line">        <span class="keyword">if</span> (prepareToHydrateHostInstance(workInProgress, rootContainerInstance, currentHostContext)) &#123;</span><br><span class="line">            </span><br><span class="line">            markUpdate(workInProgress);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> instance = createInstance(type, newProps, rootContainerInstance, currentHostContext, workInProgress);</span><br><span class="line">        appendAllChildren(instance, workInProgress, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">        workInProgress.stateNode = instance; <span class="comment">// Certain renderers require commit-time effects for initial mount.</span></span><br><span class="line">        <span class="comment">// (eg DOM renderer supports auto-focus for certain elements).</span></span><br><span class="line">        <span class="comment">// Make sure such renderers get scheduled for later work.</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (finalizeInitialChildren(instance, type, newProps, rootContainerInstance)) &#123;</span><br><span class="line">                markUpdate(workInProgress);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (workInProgress.ref !== <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// If there is a ref on a host node we need to schedule a callback</span></span><br><span class="line">            markRef$<span class="number">1</span>(workInProgress);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
跳过<code>context</code>相关和服务端渲染相关, 会进入 <code>instance = createInstance(type, newProps, rootContainerInstance, currentHostContext, workInProgress)</code>, 这里主要是创建<code>dom</code>实例, 进去看下这个函数<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createInstance</span>(<span class="params">type, props, rootContainerInstance, hostContext, internalInstanceHandle</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> parentNamespace;</span><br><span class="line"></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">var</span> hostContextDev = hostContext;</span><br><span class="line">    <span class="comment">// 检测dom是否正确嵌套</span></span><br><span class="line">    validateDOMNesting(type, <span class="literal">null</span>, hostContextDev.ancestorInfo);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> props.children === <span class="string">'string'</span> || <span class="keyword">typeof</span> props.children === <span class="string">'number'</span>) &#123;</span><br><span class="line">      <span class="keyword">var</span> string = <span class="string">''</span> + props.children;</span><br><span class="line">      <span class="keyword">var</span> ownAncestorInfo = updatedAncestorInfo(hostContextDev.ancestorInfo, type);</span><br><span class="line">      validateDOMNesting(<span class="literal">null</span>, string, ownAncestorInfo);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    parentNamespace = hostContextDev.namespace;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建dom实例</span></span><br><span class="line">  <span class="keyword">var</span> domElement = createElement(type, props, rootContainerInstance, parentNamespace);</span><br><span class="line">  <span class="comment">// 缓存这个fiber节点</span></span><br><span class="line">  precacheFiberNode(internalInstanceHandle, domElement);</span><br><span class="line">  <span class="comment">// 更新fiber节点的props, react会自己定义一个值, 所有的props将存放在当前的dom实例上</span></span><br><span class="line">  updateFiberProps(domElement, props);</span><br><span class="line">  <span class="keyword">return</span> domElement;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
返回创建好的<code>domElement</code>, 然后直接插入逻辑, 对应的代码为<code>appendAllChildren(instance, workInProgress, false, false);</code>, 看下这个函数<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">appendAllChildren = <span class="function"><span class="keyword">function</span> (<span class="params">parent, workInProgress, needsVisibilityToggle, isHidden</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 拿到当前工作单元的child Fiber节点, 即拿到第一个子节点</span></span><br><span class="line">    <span class="keyword">var</span> node = workInProgress.child;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (node !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (node.tag === HostComponent || node.tag === HostText) &#123; <span class="comment">// 如果是文本节点或者是原生dom节点</span></span><br><span class="line">            <span class="comment">// 这个函数调用的就是parent.appendChild(node.stateNode);</span></span><br><span class="line">            appendInitialChild(parent, node.stateNode);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (node.tag === HostPortal) ; <span class="keyword">else</span> <span class="keyword">if</span> (node.child !== <span class="literal">null</span>) &#123;</span><br><span class="line">            node.child.return = node;</span><br><span class="line">            node = node.child;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (node === workInProgress) &#123; <span class="comment">// 如果是当前工作单元, 插入完毕</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (node.sibling === <span class="literal">null</span>) &#123; <span class="comment">// 没有兄弟节点则Fiber向上冒泡</span></span><br><span class="line">            <span class="keyword">if</span> (node.return === <span class="literal">null</span> || node.return === workInProgress) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            node = node.return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        node.sibling.return = node.return; <span class="comment">// 把兄弟节点的return节点赋值给父节点</span></span><br><span class="line">        node = node.sibling; <span class="comment">// 把node赋值为兄弟节点</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<code>appendAllChildren</code>的作用和函数名相同, 目的就是把当前工作单元的所有子节点全部插入到刚创建好的<code>dom实例</code>中, 全部插入完毕执行<code>workInProgress.stateNode = instance;</code>, 这里采用的是深度优先遍历的方式<br>此时这里的<code>instance</code>为插入完的<code>dom</code>实例, 并把对应的节点赋值到当前<code>Fiber</code>节点的<code>stateNode</code>上<br><img src="%E6%8F%92%E5%85%A5%E5%AE%8C%E7%9A%84dom%E5%AE%9E%E4%BE%8B.png" alt=""></li>
</ol>
<p>然后执行的是<code>finalizeInitialChildren</code>方法, 此方法调用了<code>setInitialProperties</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setInitialProperties</span>(<span class="params">domElement, tag, rawProps, rootContainerElement</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> isCustomComponentTag = isCustomComponent(tag, rawProps);</span><br><span class="line"></span><br><span class="line">  &#123;</span><br><span class="line">    validatePropertiesInDevelopment(tag, rawProps);</span><br><span class="line">  &#125; <span class="comment">// <span class="doctag">TODO:</span> Make sure that we check isMounted before firing any of these events.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> props;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (tag) &#123;</span><br><span class="line">    <span class="comment">// 跳过一些dom节点的判断逻辑</span></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      props = rawProps;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 判断props是否合法</span></span><br><span class="line">  assertValidProps(tag, props);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 设置初始化的dom属性</span></span><br><span class="line">  setInitialDOMProperties(tag, domElement, rootContainerElement, props, isCustomComponentTag);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (tag) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'input'</span>:</span><br><span class="line">      track(domElement);</span><br><span class="line">      postMountWrapper(domElement, rawProps, <span class="literal">false</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="string">'textarea'</span>:</span><br><span class="line">      track(domElement);</span><br><span class="line">      postMountWrapper$<span class="number">3</span>(domElement);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="string">'option'</span>:</span><br><span class="line">      postMountWrapper$<span class="number">1</span>(domElement, rawProps);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="string">'select'</span>:</span><br><span class="line">      postMountWrapper$<span class="number">2</span>(domElement, rawProps);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> props.onClick === <span class="string">'function'</span>) &#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> This cast may not be sound for SVG, MathML or custom elements.</span></span><br><span class="line">        trapClickOnNonInteractiveElement(domElement);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的函数主要是判断了<code>props</code>是否合法, 并对特殊的<code>dom</code>节点做了一些操作, 并把初始化的属性赋值到当前的<code>dom</code>上</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setInitialDOMProperties</span>(<span class="params">tag, domElement, rootContainerElement, nextProps, isCustomComponentTag</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> propKey <span class="keyword">in</span> nextProps) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!nextProps.hasOwnProperty(propKey)) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> nextProp = nextProps[propKey];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (propKey === STYLE) &#123; <span class="comment">// style的时候</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> (nextProp) &#123;</span><br><span class="line">          <span class="built_in">Object</span>.freeze(nextProp);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      setValueForStyles(domElement, nextProp);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (propKey === DANGEROUSLY_SET_INNER_HTML) &#123; <span class="comment">// dangerouslySetInnerHTML</span></span><br><span class="line">      <span class="keyword">var</span> nextHtml = nextProp ? nextProp[HTML$<span class="number">1</span>] : <span class="literal">undefined</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (nextHtml != <span class="literal">null</span>) &#123;</span><br><span class="line">        setInnerHTML(domElement, nextHtml);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (propKey === CHILDREN) &#123; <span class="comment">// children</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> nextProp === <span class="string">'string'</span>) &#123;  <span class="comment">// 如果节点是字符串</span></span><br><span class="line">        <span class="keyword">var</span> canSetTextContent = tag !== <span class="string">'textarea'</span> || nextProp !== <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (canSetTextContent) &#123;</span><br><span class="line">          setTextContent(domElement, nextProp);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> nextProp === <span class="string">'number'</span>) &#123; <span class="comment">// 如果是数字就转换为字符串</span></span><br><span class="line">        setTextContent(domElement, <span class="string">''</span> + nextProp);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (propKey === SUPPRESS_CONTENT_EDITABLE_WARNING || propKey === SUPPRESS_HYDRATION_WARNING) ; <span class="keyword">else</span> <span class="keyword">if</span> (propKey === AUTOFOCUS) ; <span class="keyword">else</span> <span class="keyword">if</span> (registrationNameDependencies.hasOwnProperty(propKey)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (nextProp != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ( <span class="keyword">typeof</span> nextProp !== <span class="string">'function'</span>) &#123;</span><br><span class="line">          warnForInvalidEventListener(propKey, nextProp);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (propKey === <span class="string">'onScroll'</span>) &#123;</span><br><span class="line">          listenToNonDelegatedEvent(<span class="string">'scroll'</span>, domElement);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nextProp != <span class="literal">null</span>) &#123;</span><br><span class="line">      setValueForProperty(domElement, propKey, nextProp, isCustomComponentTag);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>复制初始化的<code>props</code>是调用了<code>setInitialDOMProperties</code>, 这个函数循环调用了新的<code>props</code>, 并对每个<code>propKey</code>做了特定的赋值操作, 这一步主要在<code>setValueForProperty</code>中, 这一步会调用<code>node.setAttribute</code>来为创建好的<code>dom</code>元素设置属性</p>
<p>继续走下去进行的是判断是否存在<code>ref</code>, 如果存在<code>ref</code>则调用<code>markRef$1(workInProgress);</code>函数</p>
<p>最后执行<code>bubbleProperties</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( (completedWork.mode &amp; ProfileMode) !== NoMode) &#123;</span><br><span class="line">      <span class="keyword">var</span> actualDuration = completedWork.actualDuration;</span><br><span class="line">      <span class="keyword">var</span> treeBaseDuration = completedWork.selfBaseDuration;</span><br><span class="line">      <span class="keyword">var</span> child = completedWork.child;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">while</span> (child !== <span class="literal">null</span>) &#123;</span><br><span class="line">        newChildLanes = mergeLanes(newChildLanes, mergeLanes(child.lanes, child.childLanes));</span><br><span class="line">        subtreeFlags |= child.subtreeFlags;</span><br><span class="line">        subtreeFlags |= child.flags;</span><br><span class="line"></span><br><span class="line">        actualDuration += child.actualDuration;</span><br><span class="line">        treeBaseDuration += child.treeBaseDuration;</span><br><span class="line">        child = child.sibling;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      completedWork.actualDuration = actualDuration;</span><br><span class="line">      completedWork.treeBaseDuration = treeBaseDuration;</span><br></pre></td></tr></table></figure>
<p><code>bubbleProperties</code> 根据<code>fiber.child</code>及<code>fiber.child.sibling</code>更新<code>subtreeFlags</code>和<code>childLanes</code>, 主要是为了标记子树有没有更新, 这样可以通过 <code>fiber.subtreeFlags</code> 快速判断子树是否有副作用钩子，不需要深度遍历. 在<code>React17版本后</code>使用<code>subtreeFlags</code>替换了<code>finishWork.firstEffect</code>的副作用链表, 操作主要发生在<code>bubbleProperties</code>函数中, 核心代码如下</p>
<h4 id="update阶段"><a href="#update阶段" class="headerlink" title="update阶段"></a>update阶段</h4><p>当进入<code>update</code>阶段, 假如我们把<code>p</code>节点的<code>Fiber</code>作为案例, 对应case为<code>HostComponent</code>会进入以下的条件分支</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (current !== <span class="literal">null</span> &amp;&amp; workInProgress.stateNode != <span class="literal">null</span>) &#123;</span><br><span class="line">    updateHostComponent$<span class="number">1</span>(current, workInProgress, type, newProps, rootContainerInstance);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (current.ref !== workInProgress.ref) &#123;</span><br><span class="line">        markRef$<span class="number">1</span>(workInProgress);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>updateHostComponent$1代码如下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">updateHostComponent$<span class="number">1</span> = <span class="function"><span class="keyword">function</span> (<span class="params">current, workInProgress, type, newProps, rootContainerInstance</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> oldProps = current.memoizedProps; <span class="comment">// 此状态为更新, 获取current的props</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (oldProps === newProps) &#123; <span class="comment">// 判断props是否相同, 相同表示进入了bailout阶段,哪怕children变了我们也不需要做什么操作,因此直接跳过</span></span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> instance = workInProgress.stateNode; <span class="comment">// 获取实例</span></span><br><span class="line">    <span class="keyword">var</span> currentHostContext = getHostContext();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> updatePayload = prepareUpdate(instance, type, oldProps, newProps, rootContainerInstance, currentHostContext);</span><br><span class="line"></span><br><span class="line">    workInProgress.updateQueue = updatePayload;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (updatePayload) &#123;</span><br><span class="line">      <span class="comment">// 标记更新, 内部直接设置workInProgress.flags |= Update</span></span><br><span class="line">      markUpdate(workInProgress);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>
<p>这里调用了一个主要的更新方法为<code>prepareUpdate</code>, 返回的<code>updatePayload</code>将被加入工作单元的更新队列中, 这个函数调用了<code>diffProperties</code>, 其中返回的<code>updatePayload</code>是一个数组, 第i项是对应的<code>propKey</code>, 第<code>i + 1</code>项是对应的<code>value</code>, 当存在<code>updatePayload</code>的时候意味着这个<code>HostComponent</code>存在增,或者更新的情况, 会调用<code>markUpdate</code>进行更新</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">diffProperties</span>(<span class="params">domElement, tag, lastRawProps, nextRawProps, rootContainerElement</span>) </span>&#123;</span><br><span class="line">  &#123;</span><br><span class="line">    validatePropertiesInDevelopment(tag, nextRawProps);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> updatePayload = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">var</span> lastProps;</span><br><span class="line">  <span class="keyword">var</span> nextProps;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (tag) &#123;</span><br><span class="line">    <span class="comment">// 这里省略了对特性的dom标签比如(input, select等)赋值lastProps和nextProps的过程</span></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      lastProps = lastRawProps;</span><br><span class="line">      nextProps = nextRawProps;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> lastProps.onClick !== <span class="string">'function'</span> &amp;&amp; <span class="keyword">typeof</span> nextProps.onClick === <span class="string">'function'</span>) &#123;</span><br><span class="line">        trapClickOnNonInteractiveElement(domElement);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 检验props</span></span><br><span class="line">  assertValidProps(tag, nextProps);</span><br><span class="line">  <span class="keyword">var</span> propKey;</span><br><span class="line">  <span class="keyword">var</span> styleName;</span><br><span class="line">  <span class="keyword">var</span> styleUpdates = <span class="literal">null</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">for</span> (propKey <span class="keyword">in</span> lastProps) &#123;</span><br><span class="line">    <span class="comment">// 针对删除的情况, 需要标记对应的propKey为null</span></span><br><span class="line">    <span class="keyword">if</span> (nextProps.hasOwnProperty(propKey) || !lastProps.hasOwnProperty(propKey) || lastProps[propKey] == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (propKey === STYLE) &#123;</span><br><span class="line">      <span class="keyword">var</span> lastStyle = lastProps[propKey];</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> (styleName <span class="keyword">in</span> lastStyle) &#123;</span><br><span class="line">        <span class="keyword">if</span> (lastStyle.hasOwnProperty(styleName)) &#123;</span><br><span class="line">          <span class="keyword">if</span> (!styleUpdates) &#123;</span><br><span class="line">            styleUpdates = &#123;&#125;;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          styleUpdates[styleName] = <span class="string">''</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (propKey === DANGEROUSLY_SET_INNER_HTML || propKey === CHILDREN) ; <span class="keyword">else</span> <span class="keyword">if</span> (propKey === SUPPRESS_CONTENT_EDITABLE_WARNING || propKey === SUPPRESS_HYDRATION_WARNING) ; <span class="keyword">else</span> <span class="keyword">if</span> (propKey === AUTOFOCUS) ; <span class="keyword">else</span> <span class="keyword">if</span> (registrationNameDependencies.hasOwnProperty(propKey)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!updatePayload) &#123;</span><br><span class="line">        updatePayload = [];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      (updatePayload = updatePayload || []).push(propKey, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (propKey <span class="keyword">in</span> nextProps) &#123;</span><br><span class="line">    <span class="keyword">var</span> nextProp = nextProps[propKey];</span><br><span class="line">    <span class="keyword">var</span> lastProp = lastProps != <span class="literal">null</span> ? lastProps[propKey] : <span class="literal">undefined</span>;</span><br><span class="line">    <span class="comment">// 针对新增或者更新的情况, 需要标记对应的propKey为null</span></span><br><span class="line">    <span class="keyword">if</span> (!nextProps.hasOwnProperty(propKey) || nextProp === lastProp || nextProp == <span class="literal">null</span> &amp;&amp; lastProp == <span class="literal">null</span>) &#123; <span class="comment">// 对应props被删除的情况</span></span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (propKey === STYLE) &#123;</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> (nextProp) &#123;</span><br><span class="line">          <span class="built_in">Object</span>.freeze(nextProp);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (lastProp) &#123;</span><br><span class="line">        <span class="comment">// 在 `lastProp` 上取消设置样式，但不在 `nextProp` 上设置.</span></span><br><span class="line">        <span class="keyword">for</span> (styleName <span class="keyword">in</span> lastProp) &#123;</span><br><span class="line">          <span class="keyword">if</span> (lastProp.hasOwnProperty(styleName) &amp;&amp; (!nextProp || !nextProp.hasOwnProperty(styleName))) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!styleUpdates) &#123;</span><br><span class="line">              styleUpdates = &#123;&#125;;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            styleUpdates[styleName] = <span class="string">''</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="comment">// 从lastProps中的style更新数据.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (styleName <span class="keyword">in</span> nextProp) &#123;</span><br><span class="line">          <span class="keyword">if</span> (nextProp.hasOwnProperty(styleName) &amp;&amp; lastProp[styleName] !== nextProp[styleName]) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!styleUpdates) &#123;</span><br><span class="line">              styleUpdates = &#123;&#125;;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            styleUpdates[styleName] = nextProp[styleName];</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!styleUpdates) &#123;</span><br><span class="line">          <span class="keyword">if</span> (!updatePayload) &#123;</span><br><span class="line">            updatePayload = [];</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          updatePayload.push(propKey, styleUpdates);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        styleUpdates = nextProp;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (propKey === DANGEROUSLY_SET_INNER_HTML) &#123;</span><br><span class="line">      <span class="keyword">var</span> nextHtml = nextProp ? nextProp[HTML$<span class="number">1</span>] : <span class="literal">undefined</span>;</span><br><span class="line">      <span class="keyword">var</span> lastHtml = lastProp ? lastProp[HTML$<span class="number">1</span>] : <span class="literal">undefined</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (nextHtml != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (lastHtml !== nextHtml) &#123;</span><br><span class="line">          (updatePayload = updatePayload || []).push(propKey, nextHtml);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (propKey === CHILDREN) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> nextProp === <span class="string">'string'</span> || <span class="keyword">typeof</span> nextProp === <span class="string">'number'</span>) &#123;</span><br><span class="line">        (updatePayload = updatePayload || []).push(propKey, <span class="string">''</span> + nextProp);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (propKey === SUPPRESS_CONTENT_EDITABLE_WARNING || propKey === SUPPRESS_HYDRATION_WARNING) ; <span class="keyword">else</span> <span class="keyword">if</span> (registrationNameDependencies.hasOwnProperty(propKey)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (nextProp != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ( <span class="keyword">typeof</span> nextProp !== <span class="string">'function'</span>) &#123;</span><br><span class="line">          warnForInvalidEventListener(propKey, nextProp);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (propKey === <span class="string">'onScroll'</span>) &#123;</span><br><span class="line">          listenToNonDelegatedEvent(<span class="string">'scroll'</span>, domElement);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!updatePayload &amp;&amp; lastProp !== nextProp) &#123;</span><br><span class="line">        updatePayload = [];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> nextProp === <span class="string">'object'</span> &amp;&amp; nextProp !== <span class="literal">null</span> &amp;&amp; nextProp.$$<span class="keyword">typeof</span> === REACT_OPAQUE_ID_TYPE) &#123;</span><br><span class="line">      nextProp.toString();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      (updatePayload = updatePayload || []).push(propKey, nextProp);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (styleUpdates) &#123;</span><br><span class="line">    &#123;</span><br><span class="line">      validateShorthandPropertyCollisionInDev(styleUpdates, nextProps[STYLE]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    (updatePayload = updatePayload || []).push(STYLE, styleUpdates);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> updatePayload;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行完这个<code>diffProperties</code>, 再执行<code>bubbleProperties(workInProgress)</code>, 然后就结束了当前节点的<code>completeWork</code></p>
<h4 id="注意点"><a href="#注意点" class="headerlink" title="注意点"></a>注意点</h4><ol>
<li><code>Fiber</code>的<code>tag</code>为<code>function</code>的时候是不会进入<code>completeWork</code>的</li>
<li>挂载的时候插入的<code>dom</code>节点的获取方式在于完成的<code>finishedWork</code>, 在<code>performSyncWorkOnRoot</code>函数中</li>
<li><code>React17之前</code>原本有一根<code>finishWork.firstEffect</code>开始的副作用链表, 始终指向的是第一个产生副作用的链表, 链表的<code>nextEffect</code>指向的是下一个具有副作用的链表, 这根链表在<code>React17版本后</code>使用<code>subtreeFlags</code>替换了, 操作主要发生在<code>bubbleProperties</code>函数中</li>
</ol>
<h2 id="全流程"><a href="#全流程" class="headerlink" title="全流程"></a>全流程</h2><p>这里梳理一下上述所说的全流程</p>
<p><img src="React-render%E5%BD%92%E9%98%B6%E6%AE%B5%E5%AE%8C%E6%95%B4%E6%B5%81%E7%A8%8B.png" alt=""></p>

        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>王八吉吉</span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>Permalink:</span>
                        <span><a href="http://auglyxu.github.io/2021/06/12/React-render%E9%98%B6%E6%AE%B5%E4%BA%8C/">http://auglyxu.github.io/2021/06/12/React-render%E9%98%B6%E6%AE%B5%E4%BA%8C/</a></span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright (c) 2019 <a href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC-BY-NC-4.0</a> LICENSE</span>
                    </p>
                
                
                     <p class="copyright-item">
                         <span>Slogan:</span>
                         <span>享受当下</span>
                     </p>
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tags/%E5%89%8D%E7%AB%AF/"># 前端</a>
                    
                        <a href="/tags/React/"># React</a>
                    
                        <a href="/tags/%E6%BA%90%E7%A0%81%E7%B3%BB%E5%88%97/"># 源码系列</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2021/09/13/HTTP/">HTTP(持续更新)</a>
            
            
            <a class="next" rel="next" href="/2021/06/01/React-render%E9%98%B6%E6%AE%B5%E4%B8%80/">React-render阶段(一)</a>
            
        </section>


    </article>
</div>

            </div>
            <footer id="footer" class="footer">
    <div class="copyright">
        <span>© 王八吉吉 | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
</footer>

    </div>
</body>

</html>